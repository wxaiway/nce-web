<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0a84ff" />
    <title>NCE - New Concept English</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
      .book-tabs {
        display: flex;
        justify-content: center;
        gap: var(--space-sm);
        margin-bottom: var(--space-xl);
      }

      .book-tabs button {
        padding: 12px 24px;
        border: 2px solid var(--border);
        background: var(--card);
        color: var(--text);
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
        font-size: 16px;
        font-weight: 500;
      }

      .book-tabs button:hover {
        border-color: var(--accent);
      }

      .book-tabs button.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .lessons-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--space-md);
      }

      .lesson-card {
        position: relative;
        padding: var(--space-lg);
        background: var(--card);
        border-radius: var(--radius);
        text-decoration: none;
        color: var(--text);
        transition: var(--transition);
        border: 2px solid transparent;
      }

      .lesson-card:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
      }

      .lesson-num {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: var(--space-xs);
      }

      .lesson-title {
        font-size: 18px;
        font-weight: 600;
      }

      .favorite-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 4px;
        opacity: 0.5;
        transition: var(--transition);
        color: var(--muted);
      }

      .favorite-btn:hover {
        opacity: 1;
        transform: scale(1.2);
      }

      .favorite-btn.active {
        opacity: 1;
        color: #FFD700;
      }

      .favorites-section {
        margin-bottom: var(--space-xl);
      }

      .favorites-section h2 {
        font-size: 20px;
        margin-bottom: var(--space-md);
        color: var(--text);
      }

      .favorites-section .lessons-grid {
        margin-bottom: var(--space-xl);
      }

      .empty-favorites {
        text-align: center;
        padding: var(--space-xl);
        color: var(--muted);
      }

      /* ‰∏äÊ¨°Â≠¶‰π† */
      .last-study-section {
        margin-bottom: var(--space-xl);
      }

      .last-study-section h2 {
        font-size: 20px;
        margin-bottom: var(--space-md);
        color: var(--text);
      }

      .last-study-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-lg);
        background: linear-gradient(135deg,
          rgba(10, 132, 255, 0.1) 0%,
          rgba(124, 77, 255, 0.1) 100%);
        border: 2px solid var(--accent);
        border-radius: var(--radius);
        text-decoration: none;
        color: var(--text);
        transition: var(--transition);
        box-shadow: var(--shadow);
      }

      .last-study-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        border-color: var(--accent-2);
      }

      .last-study-card .lesson-content {
        flex: 1;
      }

      .last-study-card .lesson-num {
        font-size: 12px;
        color: var(--accent);
        font-weight: 600;
        margin-bottom: var(--space-xs);
      }

      .last-study-card .lesson-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: var(--space-xs);
      }

      .last-study-card .progress-info {
        font-size: 13px;
        color: var(--muted);
        margin-top: var(--space-xs);
      }

      .last-study-card .continue-icon {
        flex: 0 0 auto;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: var(--accent);
      }
    </style>
  </head>
  <body>
    <header class="hero">
      <h1>New Concept English</h1>
      <p>Êñ∞Ê¶ÇÂøµËã±ËØ≠Âú®Á∫øÂ≠¶‰π†</p>
      <div style="margin-top: var(--space-md);">
        <a href="guide.html" class="control-btn" style="text-decoration: none;">üìö Â≠¶‰π†ÊåáÂØº</a>
      </div>
    </header>

    <div class="container">
      <!-- Êî∂ËóèÂàóË°® -->
      <div id="favorites" class="favorites-section" style="display: none">
        <h2>‚≠ê ÊàëÁöÑÊî∂Ëóè</h2>
        <div id="favoritesList" class="lessons-grid"></div>
      </div>

      <!-- ‰∏äÊ¨°Â≠¶‰π† -->
      <div id="lastStudy" class="last-study-section" style="display: none">
        <h2>üìñ ÁªßÁª≠Â≠¶‰π†</h2>
        <div id="lastStudyCard"></div>
      </div>

      <!-- ‰π¶Á±çÈÄâÊã© -->
      <div class="book-tabs">
        <button data-book="NCE1" class="active">Êñ∞Ê¶ÇÂøµ‰∏Ä</button>
        <button data-book="NCE2">Êñ∞Ê¶ÇÂøµ‰∫å</button>
        <button data-book="NCE3">Êñ∞Ê¶ÇÂøµ‰∏â</button>
        <button data-book="NCE4">Êñ∞Ê¶ÇÂøµÂõõ</button>
      </div>

      <!-- ËØæÁ®ãÂàóË°® -->
      <div id="lessons" class="lessons-grid"></div>
    </div>

    <script type="module">
      import { Storage } from './js/utils/storage.js';

      class IndexApp {
        constructor() {
          this.currentBook = 'NCE1';
          this.data = null;
          this.favorites = Storage.get('favorites', []);
          this.init();
        }

        async init() {
          // Âä†ËΩΩÊï∞ÊçÆ
          await this.loadData();

          // ÂàùÂßãÂåñ‰π¶Á±çÂàáÊç¢
          this.initBookTabs();

          // Ê£ÄÊü• URL hashÔºåËá™Âä®ÂàáÊç¢Âà∞ÂØπÂ∫î‰π¶Á±ç
          this.checkHashNavigation();

          // Ê∏≤ÊüìÊî∂ËóèÂàóË°®
          this.renderFavorites();

          // Ê∏≤Êüì‰∏äÊ¨°Â≠¶‰π†
          this.renderLastStudy();

          // Ê∏≤ÊüìËØæÁ®ãÂàóË°®
          this.renderLessons();
        }

        async loadData() {
          try {
            const response = await fetch(import.meta.env.BASE_URL + 'static/data.json');
            this.data = await response.json();
          } catch (error) {
            console.error('Failed to load data:', error);
          }
        }

        initBookTabs() {
          const tabs = document.querySelectorAll('[data-book]');

          tabs.forEach((tab) => {
            tab.addEventListener('click', () => {
              this.currentBook = tab.dataset.book;

              // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅÔºà‰∫íÊñ•ÈÄâÊã©Ôºâ
              tabs.forEach((t) => t.classList.toggle('active', t === tab));

              this.renderLessons();
            });
          });
        }

        renderLessons() {
          const container = document.getElementById('lessons');
          const bookNum = this.currentBook.replace('NCE', '');
          const lessons = this.data?.[bookNum] || [];

          container.innerHTML = lessons
            .map(
              (lesson, idx) => {
                const lessonKey = `${this.currentBook}/${lesson.filename}`;
                const isFavorite = this.favorites.includes(lessonKey);
                // NCE1 ÊØè‰∏™Êñá‰ª∂ÂåÖÂê´‰∏§ËØæÔºà1&2, 3&4...ÔºâÔºåÂÖ∂‰ªñÂÜåÂà´Ê≠£Â∏∏ÈÄíÂ¢û
                const lessonNumber = bookNum === '1' ? `${idx * 2 + 1}&${idx * 2 + 2}` : String(idx + 1);
                return `
            <a href="lesson.html#${lessonKey}" class="lesson-card">
              <button class="favorite-btn ${isFavorite ? 'active' : ''}" data-lesson="${lessonKey}" onclick="event.preventDefault(); window.indexApp.toggleFavorite('${lessonKey}')">
                ${isFavorite ? '‚≠ê' : '‚òÜ'}
              </button>
              <div class="lesson-num">Á¨¨ ${lessonNumber} ËØæ</div>
              <div class="lesson-title">${lesson.title}</div>
            </a>
          `;
              }
            )
            .join('');
        }

        renderFavorites() {
          const section = document.getElementById('favorites');
          const container = document.getElementById('favoritesList');

          if (this.favorites.length === 0) {
            section.style.display = 'none';
            return;
          }

          section.style.display = 'block';

          // Ëß£ÊûêÊî∂ËóèÁöÑËØæÁ®ã‰ø°ÊÅØ
          const favoriteLessons = this.favorites
            .map((key) => {
              const [book, filename] = key.split('/');
              const bookNum = book.replace('NCE', '');
              const lessons = this.data?.[bookNum] || [];
              const lessonIndex = lessons.findIndex((l) => l.filename === filename);
              const lesson = lessons[lessonIndex];
              if (!lesson) return null;

              // ËÆ°ÁÆóËØæÂè∑ÔºöNCE1 ÊòæÁ§∫ 1&2, 3&4...ÔºåÂÖ∂‰ªñÂÜåÂà´Ê≠£Â∏∏ÈÄíÂ¢û
              const lessonNumber = bookNum === '1' ? `${lessonIndex * 2 + 1}&${lessonIndex * 2 + 2}` : String(lessonIndex + 1);
              return { ...lesson, book, key, lessonNumber };
            })
            .filter(Boolean);

          container.innerHTML = favoriteLessons
            .map(
              (lesson) => `
            <a href="lesson.html#${lesson.key}" class="lesson-card">
              <button class="favorite-btn active" data-lesson="${lesson.key}" onclick="event.preventDefault(); window.indexApp.toggleFavorite('${lesson.key}')">
                ‚≠ê
              </button>
              <div class="lesson-num">Á¨¨ ${lesson.lessonNumber} ËØæ</div>
              <div class="lesson-title">${lesson.title}</div>
            </a>
          `
            )
            .join('');
        }

        toggleFavorite(lessonKey) {
          const index = this.favorites.indexOf(lessonKey);
          if (index > -1) {
            this.favorites.splice(index, 1);
          } else {
            this.favorites.push(lessonKey);
          }

          Storage.set('favorites', this.favorites);
          this.renderFavorites();
          this.renderLessons();
        }

        checkHashNavigation() {
          const hash = location.hash.slice(1);
          if (hash && ['NCE1', 'NCE2', 'NCE3', 'NCE4'].includes(hash)) {
            const tab = document.querySelector(`[data-book="${hash}"]`);
            if (tab) {
              // Êõ¥Êñ∞ÂΩìÂâç‰π¶Á±ç
              this.currentBook = hash;
              // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
              const tabs = document.querySelectorAll('[data-book]');
              tabs.forEach((t) => t.classList.toggle('active', t === tab));
            }
          }
        }

        renderLastStudy() {
          const section = document.getElementById('lastStudy');
          const container = document.getElementById('lastStudyCard');

          // Ëé∑ÂèñÊâÄÊúâÂ≠¶‰π†ËøõÂ∫¶
          const allProgress = Storage.get('lessonProgress', {});

          // ÊâæÂà∞ÊúÄËøëÂ≠¶‰π†ÁöÑËØæÁ®ãÔºàÊåâ lastStudy Êó∂Èó¥ÊéíÂ∫èÔºâ
          const progressEntries = Object.entries(allProgress)
            .filter(([key, progress]) => progress.lastStudy && progress.idx >= 0)
            .sort((a, b) => b[1].lastStudy - a[1].lastStudy);

          if (progressEntries.length === 0) {
            section.style.display = 'none';
            return;
          }

          const [lessonKey, progress] = progressEntries[0];
          const [book, filename] = lessonKey.split('/');
          const bookNum = book.replace('NCE', '');
          const lessons = this.data?.[bookNum] || [];
          const lessonIndex = lessons.findIndex((l) => l.filename === filename);
          const lesson = lessons[lessonIndex];

          if (!lesson) {
            section.style.display = 'none';
            return;
          }

          section.style.display = 'block';

          // ËÆ°ÁÆóËØæÂè∑
          const lessonNumber = bookNum === '1' ? `${lessonIndex * 2 + 1}&${lessonIndex * 2 + 2}` : String(lessonIndex + 1);

          // Ê†ºÂºèÂåñÊó∂Èó¥
          const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${String(s).padStart(2, '0')}`;
          };

          // ÊûÑÂª∫ËøõÂ∫¶‰ø°ÊÅØ
          const progressInfo = [
            `Á¨¨ ${lessonNumber} ËØæ`,
            progress.time > 0 ? formatTime(progress.time) : null,
            progress.percentage > 0 ? `${progress.percentage}%` : null
          ].filter(Boolean).join(' ¬∑ ');

          container.innerHTML = `
            <a href="lesson.html#${lessonKey}" class="last-study-card" data-lesson="${lessonKey}">
              <div class="lesson-content">
                <div class="lesson-num">‰∏äÊ¨°Â≠¶‰π†</div>
                <div class="lesson-title">${lesson.title}</div>
                ${progressInfo ? `<div class="progress-info">${progressInfo}</div>` : ''}
              </div>
              <div class="continue-icon">‚Üí</div>
            </a>
          `;

          // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºåËÆæÁΩÆËá™Âä®Êí≠ÊîæÊ†áËÆ∞
          const card = container.querySelector('.last-study-card');
          if (card) {
            card.addEventListener('click', (e) => {
              e.preventDefault();
              sessionStorage.setItem('nce_auto_play', '1');
              location.href = card.getAttribute('href');
            });
          }
        }
      }

      window.indexApp = new IndexApp();
    </script>

    <!-- È°µËÑö -->
    <footer class="site-footer">
      <div class="footer-content">
        <p class="footer-title">New Concept English</p>
        <p class="footer-desc">Êñ∞Ê¶ÇÂøµËã±ËØ≠Âú®Á∫øÂ≠¶‰π†Âπ≥Âè∞</p>
        <p class="footer-copyright">
          ¬© 2025 NCE. All rights reserved.
          <a href="https://github.com/wxaiway/nce-web" target="_blank" rel="noopener noreferrer" class="footer-icon-link" title="GitHub ‰ªìÂ∫ì">
            <svg class="footer-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
            </svg>
          </a>
        </p>
      </div>
    </footer>
  </body>
</html>
